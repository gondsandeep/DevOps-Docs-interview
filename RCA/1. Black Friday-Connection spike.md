# Black Friday - Connection Spike

## Incident Details

| Field | Value |
|-------|-------|
| **Severity** | SEV-1 (Critical) |
| **Service** | Payment Gateway API |
| **Duration** | 45 Minutes |
| **Status** | Resolved |
| **Owner** | Backend Team |

---

## 1. Issue Summary

At 14:00 IST, the Payment Gateway service began responding with 504 Gateway Timeouts. API latency spiked from an average of 200ms to 30s+. CPU and Memory utilization on application servers remained low (<15%), but the service was effectively unresponsive.

---

## 2. Business Impact

### User Impact
Approximately 15,000 users were unable to complete checkout transactions.

### Financial Impact
Estimated revenue loss of $X during the 45-minute window.

### Support Volume
Customer support tickets spiked by 400%.

---

## 3. Root Cause Analysis (The "5 Whys")

**Why did the requests timeout?**  
The application could not obtain a connection to the PostgreSQL database.

**Why couldn't it get a connection?**  
The database connection pool was fully exhausted (100/100 connections active).

**Why was the pool exhausted?**  
Connections were being opened but not returned to the pool.

**Why were they not returned?**  
A specific exception path in the PaymentCalculation module triggered an error, bypassing the connection close logic.

### Root Cause
**Code Logic Error.** The database connection command was missing a finally block (or try-with-resources), causing connections to remain "dangling" (open but unusable) whenever a calculation error occurred.

---

## 4. Resolution & Fix

### Immediate Fix (Time to Mitigation: 10 mins)
- Performed a rolling restart of all payment pods to forcibly close dangling connections and flush the pool
- Temporarily doubled the max_connection_pool size to 200

### Permanent Fix (Time to Resolution: 4 hours)
Deployed a hotfix wrapping the database logic in a try/finally block to ensure connections are released even during exceptions.

---

## 5. Action Items

- **[High]** Add a linting rule to CI/CD pipeline to block PRs with unsafe database closures
- **[Medium]** Configure alerts for "Connection Pool Usage > 80%"

